#!/bin/bash

VERBOSE=no
APILEVEL=
ARCH=

while [ "x$1" != "x" ]; do
    arg=$1
    shift
    case $arg in
        -v|--verbose)
            VERBOSE=yes
            ;;
        --apilevel=*)
            APILEVEL=$(expr "x$arg" : "x--apilevel=\(.*\)$")
            ;;
        --arch=*)
            ARCH=$(expr "x$arg" : "x--arch=\(.*\)$")
            ;;
        *)
            echo "Usage: $0 [options]" 1>&2;
            exit 1
            ;;
    esac
done

cd $(dirname $0)/.. || exit 1

CRYSTAX_DIR=$(pwd)
NDK_DIR=$(cd $CRYSTAX_DIR/../../ && pwd)

if [ "x$APILEVEL" = "x" ]; then
    APILEVELS=$({ for p in $(ls -d $NDK_DIR/platforms/android-* 2>/dev/null); do expr "$(basename $p)" : "^android-\(.*\)$"; done; } | sort -n)
else
    APILEVELS="$APILEVEL"
fi

log()
{
    if [ "x$VERBOSE" = "xyes" ]; then
        echo "$@"
    fi
    if [ -n "$TMPLOG" ]; then
        echo "$@" >> $TMPLOG
    fi
}

dump()
{
    echo "$@"
    if [ -n "$TMPLOG" ]; then
        echo "$@" >> $TMPLOG
    fi
}

error()
{
    dump "ERROR: $@" 1>&2
}

panic()
{
    dump "*** FATAL: $@" 1>&2
    exit 1
}

fail_panic()
{
    if [ $? -ne 0 ]; then
        panic "$@"
    fi
}

# $1: API Level
is_arch_valid()
{
    local apilevel=$1
    if [ "x$apilevel" = "x" ]; then
        error "Usage: is_arch_valid apilevel"
        exit 1
    fi

    if [ "x$apilevel" = "xL" ]; then
        return 0
    fi

    if [ $apilevel -le 19 -a "x${arch%%64}" != "x$arch" ]; then
        return 1
    else
        return 0
    fi
}

for apilevel in $APILEVELS; do
    if [ "x$ARCH" = "x" ]; then
        ARCHS=$({ for a in $(ls -d $NDK_DIR/platforms/android-${apilevel}/arch-* 2>/dev/null); do expr "$(basename $a)" : "^arch-\(.*\)$"; done; } | sort)
    else
        ARCHS=$ARCH
    fi
    for arch in $ARCHS; do
        # Skip invalid for this API level CPU architectures
        is_arch_valid $apilevel || continue

        dump "Generating CrystaX headers in \$DST/platforms/android-$apilevel/arch-$arch/include"

        adir=$NDK_DIR/platforms/android-${apilevel}/arch-${arch}/usr/include
        for f in $(find $CRYSTAX_DIR/include -type f -print | sort); do
            f=${f#$CRYSTAX_DIR/include/}
            log "Processing $f [android-${apilevel}]"

            first=$(echo "$f" | awk -F/ '{print $1}')

            if [ "x$first" != "xcrystax" -a -f $adir/$f -a ! -f $adir/crystax/google/$f ]; then
                mkdir -p $(dirname $adir/crystax/google/$f)
                fail_panic "Couldn't create Google's headers backup directory"
                mv $adir/$f $adir/crystax/google/$f
                fail_panic "Couldn't move Google's header $f into backup directory"
            fi

            mkdir -p $(dirname $adir/$f)
            fail_panic "Couldn't create target directory for CrystaX header"

            cp -f $CRYSTAX_DIR/include/$f $(dirname $adir/$f)
            fail_panic "Couldn't copy CrystaX header $f to platforms/android-$apilevel/arch-$arch"
        done
    done
done
