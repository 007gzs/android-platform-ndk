From 92c8cccfd0a30015297e5dfbd176b3416fcc3ab8 Mon Sep 17 00:00:00 2001
From: Logan Chien <loganchien@google.com>
Date: Wed, 5 Sep 2012 23:37:51 +0800
Subject: [PATCH 5/6] Fix ARM EHABI exception support.

---
 lib/CodeGen/AsmPrinter/ARMException.cpp   |   36 ++++++++++++++++++++---------
 lib/CodeGen/AsmPrinter/DwarfException.cpp |   15 ++++++++----
 lib/CodeGen/AsmPrinter/DwarfException.h   |    6 +++++
 3 files changed, 41 insertions(+), 16 deletions(-)

diff --git a/lib/CodeGen/AsmPrinter/ARMException.cpp b/lib/CodeGen/AsmPrinter/ARMException.cpp
index b60fda8..9e2f59e 100644
--- a/lib/CodeGen/AsmPrinter/ARMException.cpp
+++ b/lib/CodeGen/AsmPrinter/ARMException.cpp
@@ -71,24 +71,38 @@ void ARMException::EndFunction() {
     Asm->OutStreamer.EmitLabel(Asm->GetTempSymbol("eh_func_end",
                                                   Asm->getFunctionNumber()));
 
-    // Emit references to personality.
-    if (const Function * Personality =
-        MMI->getPersonalities()[MMI->getPersonalityIndex()]) {
-      MCSymbol *PerSym = Asm->Mang->getSymbol(Personality);
-      Asm->OutStreamer.EmitSymbolAttribute(PerSym, MCSA_Global);
-      Asm->OutStreamer.EmitPersonality(PerSym);
-    }
-
     if (EnableARMEHABIDescriptors) {
       // Map all labels and get rid of any dead landing pads.
       MMI->TidyLandingPads();
 
-      Asm->OutStreamer.EmitHandlerData();
+      const std::vector<LandingPadInfo> &PadInfos = MMI->getLandingPads();
+
+      if (!PadInfos.empty()) {
+        // Emit references to personality.
+        if (const Function * Personality =
+            MMI->getPersonalities()[MMI->getPersonalityIndex()]) {
+          MCSymbol *PerSym = Asm->Mang->getSymbol(Personality);
+          Asm->OutStreamer.EmitSymbolAttribute(PerSym, MCSA_Global);
+          Asm->OutStreamer.EmitPersonality(PerSym);
+        }
+
+        // Emit .handlerdata directive.
+        Asm->OutStreamer.EmitHandlerData();
 
-      // Emit actual exception table
-      EmitExceptionTable();
+        // Emit actual exception table
+        EmitExceptionTable();
+      }
     }
   }
 
   Asm->OutStreamer.EmitFnEnd();
 }
+
+void ARMException::EmitTypeInfoReference(const GlobalVariable *GV,
+                                         unsigned TTypeEncoding) {
+  if (GV) {
+    Asm->OutStreamer.EmitRawText("\t.word\t" + GV->getName() + "(TARGET2)\n");
+  } else {
+    Asm->OutStreamer.EmitRawText(Twine("\t.word\t0\n"));
+  }
+}
diff --git a/lib/CodeGen/AsmPrinter/DwarfException.cpp b/lib/CodeGen/AsmPrinter/DwarfException.cpp
index 70cc2e5..7d58102 100644
--- a/lib/CodeGen/AsmPrinter/DwarfException.cpp
+++ b/lib/CodeGen/AsmPrinter/DwarfException.cpp
@@ -684,11 +684,7 @@ void DwarfException::EmitExceptionTable() {
     const GlobalVariable *GV = *I;
     if (VerboseAsm)
       Asm->OutStreamer.AddComment("TypeInfo " + Twine(Entry--));
-    if (GV)
-      Asm->EmitReference(GV, TTypeEncoding);
-    else
-      Asm->OutStreamer.EmitIntValue(0,Asm->GetSizeOfEncodedValue(TTypeEncoding),
-                                    0);
+    EmitTypeInfoReference(GV, TTypeEncoding);
   }
 
   // Emit the Exception Specifications.
@@ -712,6 +708,15 @@ void DwarfException::EmitExceptionTable() {
   Asm->EmitAlignment(2);
 }
 
+void DwarfException::EmitTypeInfoReference(const GlobalVariable *GV,
+                                           unsigned TTypeEncoding) {
+  if (GV)
+    Asm->EmitReference(GV, TTypeEncoding);
+  else
+    Asm->OutStreamer.EmitIntValue(0,Asm->GetSizeOfEncodedValue(TTypeEncoding),
+                                  0);
+}
+
 /// EndModule - Emit all exception information that should come after the
 /// content.
 void DwarfException::EndModule() {
diff --git a/lib/CodeGen/AsmPrinter/DwarfException.h b/lib/CodeGen/AsmPrinter/DwarfException.h
index b5f86ab..f361d36 100644
--- a/lib/CodeGen/AsmPrinter/DwarfException.h
+++ b/lib/CodeGen/AsmPrinter/DwarfException.h
@@ -138,6 +138,9 @@ public:
 
   /// EndFunction - Gather and emit post-function exception information.
   virtual void EndFunction();
+
+  virtual void EmitTypeInfoReference(const GlobalVariable *GV,
+                                     unsigned TTypeEncoding);
 };
 
 class DwarfCFIException : public DwarfException {
@@ -203,6 +206,9 @@ public:
 
   /// EndFunction - Gather and emit post-function exception information.
   virtual void EndFunction();
+
+  virtual void EmitTypeInfoReference(const GlobalVariable *GV,
+                                     unsigned TTypeEncoding);
 };
 
 class Win64Exception : public DwarfException {
-- 
1.7.7.3

