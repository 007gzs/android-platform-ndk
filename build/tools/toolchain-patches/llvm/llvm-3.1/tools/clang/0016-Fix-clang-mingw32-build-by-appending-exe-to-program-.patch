From c48db7bbca072e6c682344a51dfacf037299bfbf Mon Sep 17 00:00:00 2001
From: Andrew Hsieh <andrewhsieh@google.com>
Date: Thu, 27 Sep 2012 16:55:27 +0800
Subject: [PATCH 16/20] Fix clang mingw32 build by appending exe to program
 for GetProgramPath

---
 lib/Driver/Driver.cpp |   17 +++++++++++++----
 1 files changed, 13 insertions(+), 4 deletions(-)

diff --git a/lib/Driver/Driver.cpp b/lib/Driver/Driver.cpp
index 6c65b2d..17571ad 100644
--- a/lib/Driver/Driver.cpp
+++ b/lib/Driver/Driver.cpp
@@ -1534,8 +1534,16 @@ static bool isPathExecutable(llvm::sys::Path &P, bool WantFile) {
 
 std::string Driver::GetProgramPath(const char *Name, const ToolChain &TC,
                                    bool WantFile) const {
+  std::string N(Name);
+#ifdef __MINGW32__
+  // We expect callers never pass Name ends with uppercase ".EXE"
+  std::string Suffix(".exe");
+  if (N.length() < Suffix.length() ||
+      (N.compare(N.length() - Suffix.length(), Suffix.length(), Suffix)) != 0)
+    N += ".exe";
+#endif
   // FIXME: Needs a better variable than DefaultTargetTriple
-  std::string TargetSpecificExecutable(DefaultTargetTriple + "-" + Name);
+  std::string TargetSpecificExecutable(DefaultTargetTriple + "-" + N);
   // Respect a limited subset of the '-Bprefix' functionality in GCC by
   // attempting to use this prefix when lokup up program paths.
   for (Driver::prefix_list::const_iterator it = PrefixDirs.begin(),
@@ -1544,7 +1552,7 @@ std::string Driver::GetProgramPath(const char *Name, const ToolChain &TC,
     P.appendComponent(TargetSpecificExecutable);
     if (isPathExecutable(P, WantFile)) return P.str();
     P.eraseComponent();
-    P.appendComponent(Name);
+    P.appendComponent(N);
     if (isPathExecutable(P, WantFile)) return P.str();
   }
 
@@ -1555,7 +1563,7 @@ std::string Driver::GetProgramPath(const char *Name, const ToolChain &TC,
     P.appendComponent(TargetSpecificExecutable);
     if (isPathExecutable(P, WantFile)) return P.str();
     P.eraseComponent();
-    P.appendComponent(Name);
+    P.appendComponent(N);
     if (isPathExecutable(P, WantFile)) return P.str();
   }
 
@@ -1565,10 +1573,11 @@ std::string Driver::GetProgramPath(const char *Name, const ToolChain &TC,
   if (!P.empty())
     return P.str();
 
-  P = llvm::sys::Path(llvm::sys::Program::FindProgramByName(Name));
+  P = llvm::sys::Path(llvm::sys::Program::FindProgramByName(N));
   if (!P.empty())
     return P.str();
 
+  // Return the original Name, not N
   return Name;
 }
 
-- 
1.7.7.3

