From d25004c052f503887cd6a848dea3a9ca23989943 Mon Sep 17 00:00:00 2001
From: Logan Chien <loganchien@google.com>
Date: Wed, 26 Sep 2012 16:16:36 +0800
Subject: [PATCH] Fix va_list name mangling issue on ARM.

Backported from the patch by Weiming Zhao.
---
 llvm-3.1/tools/clang/lib/Basic/Targets.cpp    |    8 +++++++-
 llvm-3.1/tools/clang/test/Sema/builtins-arm.c |    7 ++++---
 2 files changed, 11 insertions(+), 4 deletions(-)

diff --git a/llvm-3.1/tools/clang/lib/Basic/Targets.cpp b/llvm-3.1/tools/clang/lib/Basic/Targets.cpp
index 9a9c19e..7297594 100644
--- a/llvm-3.1/tools/clang/lib/Basic/Targets.cpp
+++ b/llvm-3.1/tools/clang/lib/Basic/Targets.cpp
@@ -2863,7 +2863,13 @@ public:
   }
   virtual bool isCLZForZeroUndef() const { return false; }
   virtual const char *getVAListDeclaration() const {
-    return "typedef void* __builtin_va_list;";
+    return "#if defined(__cplusplus)\n"
+           "  namespace std { struct __va_list { void *__ap; }; }\n"
+           "  typedef std::__va_list __builtin_va_list;\n"
+           "#else\n"
+           "  struct __va_list { void *__ap; };\n"
+           "  typedef struct __va_list __builtin_va_list;\n"
+           "#endif\n";
   }
   virtual void getGCCRegNames(const char * const *&Names,
                               unsigned &NumNames) const;
diff --git a/llvm-3.1/tools/clang/test/Sema/builtins-arm.c b/llvm-3.1/tools/clang/test/Sema/builtins-arm.c
index 4077240..0763e06 100644
--- a/llvm-3.1/tools/clang/test/Sema/builtins-arm.c
+++ b/llvm-3.1/tools/clang/test/Sema/builtins-arm.c
@@ -9,8 +9,9 @@ void __clear_cache(char*, char*);
 void __clear_cache(void*, void*);
 #endif
 
-// va_list on ARM is void*.
+// va_list on ARM is struct { void* __ap }.
 void test2() {
-  __builtin_va_list ptr = "x";
-  *ptr = '0'; // expected-error {{incomplete type 'void' is not assignable}}
+  __builtin_va_list ptr;
+  ptr.__ap = "x";
+  *(ptr.__ap) = '0'; // expected-error {{incomplete type 'void' is not assignable}}
 }
-- 
1.7.7.3

