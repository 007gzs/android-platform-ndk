#!/usr/bin/env bash

error()
{
    echo "*** ERROR: $@" 1>&2
}

HOST_OS=$(uname -s | tr '[A-Z]' '[a-z]')
case $HOST_OS in
    linux|darwin)
        ;;
    *)
        error "Host OS '$HOST_OS' is not supported"
        exit 1
esac

HOST_ARCH=$(uname -m)
case $HOST_ARCH in
    x86_64)
        ;;
    *)
        error "Host CPU architecture '$HOST_ARCH' is not supported"
        exit 1
esac

SED=
for sed in gsed sed; do
    $sed --version 2>/dev/null | head -n 1 | grep -q GNU || continue
    SED=$sed
    break
done
if [ -z "$SED" ]; then
    error "No GNU sed found!"
    exit 1
fi

NDK=$(cd $(dirname $0)/.. && pwd)
DEPLOY_ROOT=/data/local/tmp/posix
SSHD_PORT=10022
ANDROID_SERIAL=

usage()
{
    echo "Usage: $0 [options]"
    echo ""
    echo "Optional parameters:"
    echo ""
    echo "  -h,--help                  Show this screen and exit"
    echo ""
    echo "  -s,--device-id=ID          Device ID to deploy to [autodetect]"
    echo "  -r,--root=PATH             Deploy to this root folder on device"
    echo "                             [$DEPLOY_ROOT]"
    echo "  -p,--sshd-port=PORT        Port for SSH to listen for [$SSHD_PORT]"
    echo "  -n,--ndk=PATH              Path to the NDK"
    echo "                             [$NDK]"
    echo ""
}

while [ -n "$1" ]; do
    arg="$1"
    shift
    argval=$(expr "x$arg" : "^x[^=]*=\(.*\)$")
    case $arg in
        -h|--help)
            usage
            exit 0
            ;;
        -s|--device-id)
            ANDROID_SERIAL="$1"
            shift
            ;;
        --device-id=*)
            ANDROID_SERIAL="$argval"
            ;;
        -r|--root)
            DEPLOY_ROOT="$1"
            shift
            ;;
        --root=*)
            DEPLOY_ROOT="$argval"
            ;;
        -p|--sshd-port)
            SSHD_PORT="$1"
            shift
            ;;
        --sshd-port=*)
            SSHD_PORT="$argval"
            ;;
        -n|--ndk)
            NDK="$1"
            shift
            ;;
        --ndk=*)
            NDK="$argval"
            ;;
        -*)
            error "Unknown option: '$arg'"
            usage 1>&2
            exit 1
            ;;
        *)
            usage 1>&2
            exit 1
    esac
done

if [ -z "$NDK" -o -z "$DEPLOY_ROOT" -o -z "$SSHD_PORT" ]; then
    usage 1>&2
    exit 1
fi

echo $SSHD_PORT | grep -q '^[1-9][0-9]*$'
if [ $? -ne 0 ]; then
    error "Wrong SSHD port value: '$SSHD_PORT'"
    usage 1>&2
    exit 1
fi

if [ -z "$ANDROID_SERIAL" ]; then
    ANDROID_SERIAL=$(adb devices | grep '^[^\s][^\s]*\s\s*device$' | head -n 1 | cut -f 1)
    if [ -z "$ANDROID_SERIAL" ]; then
        error "Can't detect Android device for deploy"
        exit 1
    fi
    echo "=== Auto-detected Android device '$ANDROID_SERIAL'"
fi
export ANDROID_SERIAL

run()
{
    echo "## COMMAND: $@"
    "$@"
}

device_abi()
{
    adb shell getprop ro.product.cpu.abi | $SED 's,[[:cntrl:]]*,,g'
}

adb_shell()
{
    run adb shell "$@"
}

adb_push()
{
    run adb push "$@"
}

set_sshd_config_value()
{
    local file=$1
    local name=$2
    local value=$3

    if [ -z "$file" -o -z "$name" -o -z "$value" ]; then
        error "Usage: set_sshd_config_value file name value"
        return 1
    fi

    local warnstr='# deploy-posix-environment customized settings:'
    grep -q "^$warnstr$" $file
    if [ $? -ne 0 ]; then
        echo "" >>$file || return 1
        echo "$warnstr" >>$file || return 1
    fi

    $SED -i "s|^\($name\>.*\)$|#\1|g" $file || return 1
    echo "$name $value" >>$file || return 1
    return 0
}

DEVABI=$(device_abi)
if [ -z "$DEVABI" ]; then
    error "Can't detect main ABI for device '$ANDROID_SERIAL'"
    exit 1
fi

case $DEVABI in
    armeabi-v7a)
        DEVARCH=arm
        ;;
    arm64*)
        DEVARCH=arm64
        ;;
    x86|x86_64|mips|mips64)
        DEVARCH=$DEVABI
        ;;
    *)
        error "Unsupported device CPU ABI: '$DEVABI'"
        exit 1
esac

case $DEVARCH in
    arm)
        TCPREFIX=arm-linux-androideabi
        ;;
    arm64)
        TCPREFIX=aarch64-linux-android
        ;;
    mips)
        TCPREFIX=mipsel-linux-android
        ;;
    mips64)
        TCPREFIX=mips64el-linux-android
        ;;
    x86)
        TCPREFIX=i686-linux-android
        ;;
    x86_64)
        TCPREFIX=x86_64-linux-android
        ;;
esac

case $DEVARCH in
    x86|x86_64)
        TCNAME=$DEVARCH
        ;;
    *)
        TCNAME=$TCPREFIX
esac

case $DEVABI in
    armeabi*)
        ABI=armeabi-v7a-hard
        ;;
    *)
        ABI=$DEVABI
esac

STRIP=$NDK/toolchains/${TCNAME}-6/prebuilt/${HOST_OS}-${HOST_ARCH}/bin/${TCPREFIX}-strip
if [ ! -x "$STRIP" ]; then
    error "No 'strip' tool found for CPU architecture '$DEVARCH'"
    exit 1
fi

OPENSSH_ROOT="$NDK/packages/openssh"

OPENSSH_VERSION=$(ls -1 $OPENSSH_ROOT/ | sort | uniq | tail -n 1)
if [ -z "$OPENSSH_VERSION" ]; then
    error "Can't detect OpenSSH version"
    exit 1
fi

OPENSSH_ROOT="$OPENSSH_ROOT/$OPENSSH_VERSION/$ABI"

GNU_WHICH_ROOT="$NDK/packages/gnu-which"
GNU_WHICH_VERSION=$(ls -1 $GNU_WHICH_ROOT/ | sort | uniq | tail -n 1)
if [ -z "$GNU_WHICH_VERSION" ]; then
    error "Can't detect GNU which version"
    exit 1
fi

GNU_WHICH_ROOT="$GNU_WHICH_ROOT/$GNU_WHICH_VERSION/$ABI"

BINS="        \
    bash      \
    coreutils \
    grep      \
    sed       \
    tar       \
    unzip     \
    zip       \
    "

RTAG=$(uuidgen | $SED 's,-,,g')

trap "rm -f /tmp/*.$RTAG" EXIT INT QUIT ABRT TERM

for d in bin etc lib libexec run sbin; do
    adb_shell mkdir -p $DEPLOY_ROOT/$d/ || exit 1
    adb_shell chmod 0755 $DEPLOY_ROOT/$d/ || exit 1
done
adb_shell mkdir -p $DEPLOY_ROOT/tmp/ || exit 1
adb_shell chmod 0777 $DEPLOY_ROOT/tmp/ || exit 1

LIBCRYSTAX_STRIPPED=/tmp/libcrystax.so.$RTAG
run cp -f $NDK/sources/crystax/libs/$ABI/libcrystax.so $LIBCRYSTAX_STRIPPED || exit 1
run $STRIP $LIBCRYSTAX_STRIPPED || exit 1
adb_push $LIBCRYSTAX_STRIPPED $DEPLOY_ROOT/lib/libcrystax.so || exit 1
adb_shell chmod 0644 $DEPLOY_ROOT/lib/libcrystax.so || exit 1
rm -f $LIBCRYSTAX_STRIPPED

for f in $BINS; do
    STRIPPED=/tmp/$f.$RTAG
    run cp -f $NDK/prebuilt/android-$DEVARCH/posix/bin/$f $STRIPPED || exit 1
    run $STRIP $STRIPPED || exit 1
    adb_push $STRIPPED $DEPLOY_ROOT/bin/$f || exit 1
    adb_shell chmod 0755 $DEPLOY_ROOT/bin/$f || exit 1
    rm -f $STRIPPED
done

for f in $GNU_WHICH_ROOT/*; do
    STRIPPED=/tmp/$(basename $f).$RTAG
    run cp -f $f $STRIPPED || exit 1
    run $STRIP $STRIPPED || exit 1
    dstf=$DEPLOY_ROOT/bin/$(basename $f)
    adb_shell mkdir -p $(dirname $dstf) || exit 1
    adb_push $STRIPPED $dstf || exit 1
    adb_shell chmod 0755 $dstf || exit 1
    rm -f $STRIPPED
done

for f in $OPENSSH_ROOT/bin/* $OPENSSH_ROOT/sbin/* $OPENSSH_ROOT/libexec/*; do
    STRIPPED=/tmp/$(basename $f).$RTAG
    run cp -f $f $STRIPPED || exit 1
    run $STRIP $STRIPPED || exit 1
    dstf=$DEPLOY_ROOT/$(echo $f | $SED "s,$OPENSSH_ROOT/,,")
    adb_shell mkdir -p $(dirname $dstf) || exit 1
    adb_push $STRIPPED $dstf || exit 1
    adb_shell chmod 0755 $dstf || exit 1
    rm -f $STRIPPED
done

for f in $OPENSSH_ROOT/etc/*; do
    srcf=/tmp/$(basename $f).$RTAG
    dstf=$DEPLOY_ROOT/$(echo $f | $SED "s,$OPENSSH_ROOT/,,")
    cat $f | $SED "s,\$DEPLOY_ROOT,$DEPLOY_ROOT,g" >$srcf || exit 1
    case $f in
        */sshd_config)
            set_sshd_config_value $srcf Port $SSHD_PORT || exit 1
            set_sshd_config_value $srcf PasswordAuthentication no || exit 1
            set_sshd_config_value $srcf UsePrivilegeSeparation no || exit 1
            set_sshd_config_value $srcf UseDNS no || exit 1
            set_sshd_config_value $srcf AllowAgentForwarding yes || exit 1
            set_sshd_config_value $srcf PermitTTY yes || exit 1
            set_sshd_config_value $srcf AuthorizedKeysFile "$DEPLOY_ROOT/.ssh/authorized_keys" || exit 1
            #set_sshd_config_value $srcf PidFile "$DEPLOY_ROOT/run/sshd.pid" || exit 1
            #set_sshd_config_value $srcf LogLevel DEBUG3 || exit 1
            #for t in rsa dsa ecdsa ed25519; do
            #    HOST_KEY=$DEPLOY_ROOT/etc/ssh_host_${t}_key
            #    echo "HostKey $HOST_KEY" >>$srcf || exit 1
            #done
    esac
    adb_shell mkdir -p $(dirname $dstf) || exit 1
    adb_push $srcf $dstf || exit 1
    adb_shell chmod 0644 $dstf || exit 1
    rm -f $srcf
done

MKCOREUTILS=/tmp/mkcoreutils.$RTAG
echo "cd $DEPLOY_ROOT/bin/ || exit 1" >$MKCOREUTILS
for u in $(cat $NDK/tools/coreutils.txt); do
    echo "rm -f $u || exit 1" >>$MKCOREUTILS
    echo "ln -s coreutils $u || exit 1" >>$MKCOREUTILS
done
adb_push $MKCOREUTILS $DEPLOY_ROOT/tmp/mkcoreutils
adb_shell "HOME=$DEPLOY_ROOT LD_LIBRARY_PATH=$DEPLOY_ROOT/lib $DEPLOY_ROOT/bin/bash $DEPLOY_ROOT/tmp/mkcoreutils" || exit 1
adb_shell rm -f $DEPLOY_ROOT/mkcoreutils

BASH_PROFILE=/tmp/bash_profile.$RTAG
cat >$BASH_PROFILE <<EOF
if [ "\$HOME" != "$DEPLOY_ROOT" ]; then
    echo "*** ERROR: HOME doesn't point to $DEPLOY_ROOT!" 1>&2
    echo "*** ERROR: Re-run Bash again with HOME=$DEPLOY_ROOT!" 1>&2
    exit 1
fi

umask 0022

alias mv='mv -i'
alias cp='cp -i'
alias ll='ls --color=auto -FAl'
alias tf='tail -F'

SHELL=\$HOME/bin/bash
export SHELL

TMP=\$HOME/tmp
TMPDIR=\$TMP
export TMP TMPDIR

LD_LIBRARY_PATH=\$HOME/lib
export LD_LIBRARY_PATH

PATH=\$HOME/bin:\$PATH
export PATH

cd \$HOME
EOF

adb_push $BASH_PROFILE $DEPLOY_ROOT/.bash_profile
rm -f $BASH_PROFILE

BASH="HOME=$DEPLOY_ROOT $DEPLOY_ROOT/bin/bash --login"
for t in rsa dsa ecdsa ed25519; do
    HOST_KEY=$DEPLOY_ROOT/etc/ssh_host_${t}_key
    adb_shell "$BASH -c 'test -f $HOST_KEY || $DEPLOY_ROOT/bin/ssh-keygen -t $t -N \"\" -f $HOST_KEY'" || exit 1
done

adb_shell "$BASH -c 'kill \`cat $DEPLOY_ROOT/run/sshd.pid 2>/dev/null\` 2>/dev/null'"
adb_shell "$BASH -c 'HOME=$DEPLOY_ROOT $DEPLOY_ROOT/sbin/sshd -x $DEPLOY_ROOT'"
